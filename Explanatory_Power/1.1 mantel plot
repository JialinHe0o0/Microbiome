# jialin He 202307

library(linkET)
var <- c('age','BMI','waist','TG','TC','HDL','LDL')
table1 <- metadata[,var]

res <- mantel_function(microdat = fungi,metadata = table1,var = var,
                       method = 'pearson',sample_in_row = T,
                       community_name = 'Fungi',
                       rbreak = c(-Inf,0.05,0.1,Inf),
                       rlabel = c('<0.05','0.05-0.1','>0.1'))

res2 <- mantel_function(microdat = bac,
                        metadata = table1,var = var,
                        method = 'pearson',sample_in_row = T,
                        community_name = 'Bacteria',
                        rbreak = c(-Inf,0.05,0.1,Inf),
                        rlabel = c('<0.05','0.05-0.1','>0.1'))

res_all <- rbind(res,res2)

res_all <- filter(res_all,p<0.05)
correlate(table1,method = 'spearman',engine = "WGCNA") %>%
  qcorrplot(type = "lower", diag = FALSE) +
  geom_square() +
  geom_couple(aes(colour = plabel, size = rlabel),
              data = res_all, curvature = 0.1) +
  # scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdBu"))+
  scale_fill_gradientn(colours = c('#98c1d9','white','#f5cac3'))+
  scale_size_manual(values = c(1,2,3))+
  scale_colour_manual(values = c("#e29578",'#006d77','grey'))+
  guides(size = guide_legend(title = "Mantel's r",
                             override.aes = list(color = 'grey35'), 
                             order = 2),
         colour = guide_legend(title = "Mantel's P", 
                               override.aes = list(size = 3), 
                               order = 1),
         fill = guide_colorbar(title = "Spearman's r",
                               order = 3)) +
  labs(title = "Mantel test")+
  theme(plot.title = element_text(family = "serif",size=15),
        axis.title.x= element_blank(),
        axis.title.y= element_blank(),
        axis.text.x= element_text(family = "serif",size=12),
        axis.text.y= element_text(family = "serif",size=12),
        plot.caption = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(family = "serif",size=12),
        legend.text = element_text(family = "serif",size=10),
        legend.key.size = unit(0.5,'cm'),
        plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm"))

ggsave(filename = 'C://xxx//Mantel.pdf',width = 8,height = 6)
